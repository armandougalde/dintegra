{% extends "base_generic.html" %}

{% block content %}
  <h2 class="mb-3">Capturar Detalles del Pedido</h2>

  <!-- Mostrar los datos del pedido en la parte superior -->
  <div class="pedido-info mb-3">
    <h4>Información del Pedido</h4>
    <p><strong>Número de Pedido:</strong> {{ pedido.numero_pedido }}</p>
    <p><strong>Fecha de Solicitud:</strong> {{ pedido.fecha_solicitud }}</p>
    <p><strong>Cliente:</strong> {{ pedido.cliente.nombre }}</p>
    <p><strong>Contrato:</strong> {{ pedido.contrato.numero_contrato }}</p>
    <p><strong>Almacén de Entrega:</strong> {{ pedido.almacen_entrega.nombre }}</p>
  </div>

  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    
    <h3>Detalle de Productos</h3>
    {{ detalle_formset.management_form }}
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Presentación</th>
          <th>Atenciones</th>
          <th>Precio Unitario</th>
          <th>Importe</th>
        </tr>
      </thead>
      <tbody>
        {% for form in detalle_formset %}
          <tr>
            <td>{{ form.producto }}</td>
            <td>{{ form.cantidad }}</td>
            <td>{{ form.presentacion }}</td>
            <td>{{ form.atenciones }}</td>
            <td>{{ form.precio_unitario }}</td>
            <td>{{ form.importe }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    
    <button type="submit">Guardar Pedido</button>
  </form>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      function updateTotals() {
        let subtotal = 0;
        document.querySelectorAll('.detalle-row').forEach(function(row) {
          let precio = parseFloat(row.querySelector('.precio-unitario').value) || 0;
          let cantidad = parseFloat(row.querySelector('input[name$="-cantidad"]').value) || 0;
          let importe = precio * cantidad;
          row.querySelector('.importe').value = importe.toFixed(2);
          subtotal += importe;
        });
        let iva = subtotal * 0.16;
        let total = subtotal + iva;
        document.getElementById('subtotal').value = subtotal.toFixed(2);
        document.getElementById('iva').value = iva.toFixed(2);
        document.getElementById('total').value = total.toFixed(2);
      }

      document.querySelectorAll('.producto-select').forEach(function(select) {
        select.addEventListener('change', function() {
          let selectedOption = this.options[this.selectedIndex];
          let precio = selectedOption.getAttribute('data-precio');
          let row = this.closest('tr');
          row.querySelector('.precio-unitario').value = precio;
          updateTotals();
        });
      });

      document.querySelectorAll('input[name$="-cantidad"]').forEach(function(input) {
        input.addEventListener('input', updateTotals);
      });

      document.querySelector('.add-row').addEventListener('click', function() {
        let newRow = document.querySelector('.detalle-row').cloneNode(true);
        newRow.querySelectorAll('input, select').forEach(function(input) {
          if (input.tagName.toLowerCase() === 'select') {
            input.value = "";
          } else {
            input.value = "";
          }
        });
        document.getElementById('detalle-body').appendChild(newRow);
        // Reattach event listeners to new row
        newRow.querySelector('.producto-select').addEventListener('change', function() {
          let selectedOption = this.options[this.selectedIndex];
          let precio = selectedOption.getAttribute('data-precio');
          let row = this.closest('tr');
          row.querySelector('.precio-unitario').value = precio;
          updateTotals();
        });
        newRow.querySelector('input[name$="-cantidad"]').addEventListener('input', updateTotals);
      });

      document.getElementById('detalle-body').addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-row')) {
          let row = event.target.closest('tr');
          row.remove();
          updateTotals();
        }
      });

      updateTotals();  // Initial calculation
    });
  </script>
{% endblock %}
