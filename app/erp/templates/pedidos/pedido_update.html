{% extends "base_generic.html" %}

{% block content %}
<h2>Editar Pedido</h2>

<form method="post" id="pedido-form">
    {% csrf_token %}
    
    {{ form.as_p }}
    
    <h3>Detalle de Productos</h3>

    <!-- Asegúrate de que el management form esté presente -->
    {{ detalle_formset.management_form }}
    {{ form.id }}
    <table class="table" id="detalle-productos-table">
        <thead>
            <tr>
                <th>Cantidad</th>
                <th>Presentación</th>
                <th>Total Litros</th>
                <th>Producto</th>
                <th>Atenciones</th>
                <th>Precio Unitario</th>
                <th>Precio Presentación</th>
                <th>Importe</th>
                <th>Eliminar</th>
            </tr>
        </thead>
        <tbody>
            <input type="hidden" name="detalles-TOTAL_FORMS" id="id_form-TOTAL_FORMS" value="1">
            {% for form in detalle_formset %}
              <tr class="detalle-row">
                {{ form.id }} <!-- Asegura que este campo esté presente -->
                <td>
                  <input type="number" name="{{ form.prefix }}-cantidad" class="form-control cantidad" min="1" value="{{ form.cantidad.value }}">
                </td>
                <td>
                  <select name="{{ form.prefix }}-presentacion" class="form-control presentacion-select">
                    <option value="">Seleccione una presentación</option>
                    {% for presentacion in presentaciones %}
                    <option value="{{ presentacion.id }}" data-cantidad="{{ presentacion.cantidad }}" {% if form.instance.presentacion and form.instance.presentacion.id == presentacion.id %}selected{% endif %}>
                        {{ presentacion.nombre }}
                    </option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                    <input type="text" name="{{ form.prefix }}-total_litros" class="form-control total-litros" value="{{ form.initial.total_litros }}" readonly>
                </td>
                <td>
                  <select name="{{ form.prefix }}-producto" class="form-control producto-select">
                    <option value="">Seleccione un producto</option>
                    {% for producto in productos %}
                      <option value="{{ producto.id }}" data-precio="{{ producto.precio_unitario }}"
                        {% if form.instance.producto and form.instance.producto.id == producto.id %}selected{% endif %}>
                        {{ producto.nombre }}
                      </option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input type="text" name="{{ form.prefix }}-atenciones" class="form-control atenciones" value="{{ form.atenciones.value }}">
                </td>
                <td>
                  <input type="text" name="{{ form.prefix }}-precio_unitario" class="form-control precio-unitario" value="{{ form.precio_unitario.value }}" readonly>
                </td>
                <td>
                    <input type="text" name="{{ form.prefix }}-precio_presentacion" class="form-control precio-presentacion" value="{{ form.initial.precio_presentacion }}" readonly>
                </td>
                <td>
                    <input type="text" name="{{ form.prefix }}-importe" class="form-control importe" value="{{ form.initial.importe }}" readonly>
                </td>
                <td>
                    <input type="checkbox" name="{{ form.prefix }}-DELETE" class="form-check-input delete-checkbox d-none"> <!-- Campo DELETE -->
                  <button type="button" class="btn btn-danger remove-row">Eliminar</button>
                  </td>
              </tr>
            {% endfor %}
          </tbody>
    </table>
    <button type="button" id="add-row" class="btn btn-primary">Añadir Producto</button>
    <hr>
    <h3>Resumen del Pedido</h3>
    <div class="form-group">
        <label>Subtotal:</label>
        <input type="text" id="subtotal" class="form-control" readonly>
    </div>
    <div class="form-group">
        <label>IVA (16%):</label>
        <input type="text" id="iva" class="form-control" readonly>
    </div>
    <div class="form-group">
        <label>Total:</label>
        <input type="text" id="total" class="form-control" readonly>
    </div>
    <button type="submit" class="btn btn-success">Guardar Pedido</button>
    <a href="{% url 'pedido-list' %}" class="btn btn-secondary">Cancelar</a>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
      let totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
      let formIdx = parseInt(totalFormsInput.value, 10);
  
      // Manejo de cliente para filtrar contratos y almacenes
      $(document).ready(function() {
          $('#id_cliente').change(function() {
              const clienteId = $(this).val();
              if (clienteId) {
                  $.ajax({
                      url: "{% url 'filtrar-contratos-almacenes' %}",
                      data: {
                          'cliente_id': clienteId
                      },
                      success: function(data) {
                          const contratosSelect = $('#id_contrato');
                          contratosSelect.empty();
                          contratosSelect.append('<option value="">Seleccione un contrato</option>');
                          data.contratos.forEach(contrato => {
                              contratosSelect.append(`<option value="${contrato.id}">${contrato.numero_contrato}</option>`);
                          });
  
                          const almacenesSelect = $('#id_almacen_entrega');
                          almacenesSelect.empty();
                          almacenesSelect.append('<option value="">Seleccione un almacén</option>');
                          data.almacenes.forEach(almacen => {
                              almacenesSelect.append(`<option value="${almacen.id}">${almacen.nombre}</option>`);
                          });
                      }
                  });
              } else {
                  $('#id_contrato').empty().append('<option value="">Seleccione un contrato</option>');
                  $('#id_almacen_entrega').empty().append('<option value="">Seleccione un almacén</option>');
              }
          });
      });
  
      function attachEventListeners(row) {
          let productoSelect = row.querySelector('.producto-select');
          let cantidadInput = row.querySelector('.cantidad');
          let precioInput = row.querySelector('.precio-unitario');
          let importeInput = row.querySelector('.importe');
          let presentacionSelect = row.querySelector('.presentacion-select');
          let totalLitrosInput = row.querySelector('.total-litros');
          let precioPresentacionInput = row.querySelector('.precio-presentacion');
          let deleteButton = row.querySelector('.remove-row'); // Botón de eliminar
  
          // Evento al cambiar la presentación
          presentacionSelect.addEventListener('change', function () {
              let cantidad = parseFloat(cantidadInput.value) || 0;
              let presentacionCantidad = parseFloat(this.options[this.selectedIndex].getAttribute('data-cantidad')) || 0;
              let precio = parseFloat(precioInput.value) || 0;
  
              let totalLitros = cantidad * presentacionCantidad;
              totalLitrosInput.value = totalLitros.toFixed(2);
  
              let precioPresentacion = precio * presentacionCantidad;
              precioPresentacionInput.value = precioPresentacion.toFixed(2);
  
              let importe = cantidad * precioPresentacion;
              importeInput.value = importe.toFixed(2);
              updateTotals();
          });
  
          // Evento para actualizar el precio unitario cuando se selecciona un producto
          productoSelect.addEventListener('change', function () {
              let selectedOption = this.options[this.selectedIndex];
              let precio = selectedOption.getAttribute('data-precio') || 0;
              precioInput.value = precio;
              presentacionSelect.dispatchEvent(new Event('change'));
              updateTotals();
          });
  
          // Evento para actualizar los totales cuando cambia la cantidad
          cantidadInput.addEventListener('input', function () {
              presentacionSelect.dispatchEvent(new Event('change'));
              updateTotals();
          });
  
          // Evento para eliminar la fila y verificar si es la última
          deleteButton.addEventListener('click', function () {
              let rows = document.querySelectorAll('.detalle-row');
              if (rows.length > 1) { // Solo eliminar si hay más de una fila
                  row.remove();
                  updateTotals();
              } else {
                  alert('No puedes eliminar todos los productos. Debe haber al menos un producto en el pedido.');
              }
          });
      }
  
      document.querySelectorAll('.detalle-row').forEach(function (row) {
          attachEventListeners(row);
      });
  
      document.getElementById('add-row').addEventListener('click', function () {
          let newRow = document.querySelector('.detalle-row').cloneNode(true);
  
          newRow.querySelectorAll('input, select').forEach(function (input) {
              input.name = input.name.replace(/-\d+-/, `-${formIdx}-`);
              input.id = input.id.replace(/_\d+_/, `_${formIdx}_`);
              if (input.type !== 'hidden') input.value = '';
              if (input.tagName.toLowerCase() === 'select') input.selectedIndex = 0;
          });
  
          document.querySelector('#detalle-productos-table tbody').appendChild(newRow);
          formIdx++;
          totalFormsInput.value = formIdx;
          attachEventListeners(newRow);
          updateTotals();
      });
  
      function updateTotals() {
          let subtotal = 0;
          document.querySelectorAll('.detalle-row').forEach(function (row) {
              let importe = parseFloat(row.querySelector('.importe')?.value) || 0;
              subtotal += importe;
          });
          let iva = subtotal * 0.16;
          let total = subtotal + iva;
          document.getElementById('subtotal').value = subtotal.toFixed(2);
          document.getElementById('iva').value = iva.toFixed(2);
          document.getElementById('total').value = total.toFixed(2);
      }
  
      updateTotals();
  });

  
</script>




<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('.datepicker').datepicker({
        format: 'yyyy-mm-dd',
        autoclose: true,
        todayHighlight: true,
        language: 'es'
    });
});
</script>

{% endblock %}
