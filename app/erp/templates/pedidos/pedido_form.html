{% extends "body.html" %}
{% load humanize %}
{% load form_tags %}

{% block content %}

<form method="post" id="pedido-form">
    <div class="card ">
        <div class="card-body ">
            <h5 class="card-title">Captura de Tarjetas de Distribución</h5>
            <div class="row">
                {% csrf_token %}
                
                <div class="col-md-3">
                    <label>Número de Tarjeta:</label>
                    <div class="col-sm-10">
                        {{ pedido_form.numero_pedido }}
                    </div>
                </div>

                <div class="col-md-3">
                  <label>Cliente</label>
                  <div class="col-sm-10">
                      {{ pedido_form.cliente }}
                  </div>
              </div>
              
              <div class="col-md-3">
                  <label>Contrato</label>
                  <div class="col-sm-10">
                      {{ pedido_form.contrato }}
                  </div>
              </div>

                <div class="col-md-3">
                    <label>Fecha Solicitud</label>
                    <div class="col-sm-6">
                        {{ pedido_form.fecha_solicitud }}
                    </div>
                </div>

                <div class="col-md-3">
                    <label>Entrega:</label>
                    <div class="col-sm-10">
                        {{ pedido_form.almacen_entrega }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card col-md-12 ">
        <div class="card-body col-md-12 ">
            <h5 class="card-title">Captura de productos</h5>
            
            {{ detalle_formset.management_form }}
            <input type="hidden" name="detalles-TOTAL_FORMS" id="id_form-TOTAL_FORMS" value="{{ detalle_formset.total_form_count }}">
            
            <table class="table" id="detalle-productos-table">
                <thead>
                    <tr>
                        <th>Cantidad</th>
                        <th>Presentación</th>
                        <th>Total litros</th>
                        <th>Producto</th>
                        <th>Atenciones</th>
                        <th>Precio Unitario</th>
                        <th>Precio Presentación</th>
                        <th>Importe</th>
                        <th>Eliminar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in detalle_formset %}
                    <tr class="detalle-row">
                        <td class="col-1">
                            <input type="number" name="{{ form.prefix }}-cantidad" class="form-control cantidad" min="1" value="{{ form.cantidad.value }}">
                        </td>
                        <td>
                            <select name="{{ form.prefix }}-presentacion" class="form-control presentacion-select">
                                <option value="">Seleccione...</option>
                                {% for presentacion in presentaciones %}
                                <option value="{{ presentacion.id }}" data-cantidad="{{ presentacion.cantidad }}" {% if form.instance.presentacion and form.instance.presentacion.id == presentacion.id %}selected{% endif %}>
                                    {{ presentacion.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="text" name="{{ form.prefix }}-total_litros" class="form-control total-litros" value="{{ form.total_litros.value }}" readonly>
                        </td>
                        <td class="col-4">
                            <select name="{{ form.prefix }}-producto" class="form-control producto-select">
                                <option value="">Seleccione...</option>
                                {% for producto in productos %}
                                <option value="{{ producto.id }}" data-precio="{{ producto.precio_unitario }}"
                                    {% if form.instance.producto and form.instance.producto.id == producto.id %}selected{% endif %}>
                                    {{ producto.descripcion }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="text" name="{{ form.prefix }}-atenciones" class="form-control atenciones" value="{{ form.atenciones.value }}">
                        </td>
                        <td>
                            <div class="input-group mb-3">
                                <span class="input-group-text">$</span>
                                <input type="text" name="{{ form.prefix }}-precio_unitario" class="form-control precio-unitario" value="{{ form.precio_unitario.value }}" readonly>
                            </div>
                        </td>
                        <td>
                            <div class="input-group mb-3">
                                <span class="input-group-text">$</span>
                                <input type="text" name="{{ form.prefix }}-precio_presentacion" class="form-control precio-presentacion" value="{{ form.precio_presentacion.value|floatformat:2|intcomma }}" readonly>
                            </div>
                        </td>
                        <td>
                            <div class="input-group mb-3">
                                <span class="input-group-text">$</span>
                                <input type="text" name="{{ form.prefix }}-importe" class="form-control importe" value="{{ form.importe.value }}" readonly>
                            </div>
                        </td>
                        <td>
                            <input type="checkbox" name="{{ form.prefix }}-DELETE" class="form-check-input d-none"> <!-- Campo DELETE oculto -->
                            <button type="button" class="btn btn-danger remove-row"><i class="bi bi-exclamation-octagon"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="button" id="add-row" class="btn btn-primary"><i class="bi bi-cart-plus"></i> Agregar</button>
            <hr>
        </div>
    </div>

    <div class="d-flex">
        <div class="card col-8">
            <div class="card-body">
                <h5 class="card-title"></h5>
                <div class="d-flex justify-content-start">
                    <button type="submit" class="btn btn-success me-2"><i class="bi bi-floppy"></i> Guardar</button>
                    <!-- Botón Cancelar -->
                    <a href="{% url 'pedido-list' %}">
                        <button type="button" class="btn btn-warning"><i class="bi bi-backspace"></i> Atras</button>
                    </a>
                </div>
            </div>
        </div>

        <div class="card col-3 ms-auto">
            <div class="card-body col-md-12">
                <h5 class="card-title">Importe</h5>
                <div class="form-group">
                    <label>Subtotal:</label>
                    <input type="text" id="subtotal" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>IVA (16%):</label>
                    <input type="text" id="iva" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Total:</label>
                    <input type="text" id="total" class="form-control" readonly>
                </div>
            </div>
        </div>
    </div>
</form>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
      let formIdx = parseInt(totalFormsInput.value, 10);
  
      
  
      function attachEventListeners(row) {
          let productoSelect = row.querySelector('.producto-select');
          let cantidadInput = row.querySelector('.cantidad');
          let precioInput = row.querySelector('.precio-unitario');
          let importeInput = row.querySelector('.importe');
          let presentacionSelect = row.querySelector('.presentacion-select');
          let totalLitrosInput = row.querySelector('.total-litros');
          let precioPresentacionInput = row.querySelector('.precio-presentacion');
          let deleteButton = row.querySelector('.remove-row'); // Botón de eliminar
  
          // Evento al cambiar la presentación
          presentacionSelect.addEventListener('change', function () {
              let cantidad = parseFloat(cantidadInput.value) || 0;
              let presentacionCantidad = parseFloat(this.options[this.selectedIndex].getAttribute('data-cantidad')) || 0;
              let precio = parseFloat(precioInput.value) || 0;
  
              let totalLitros = cantidad * presentacionCantidad;
              totalLitrosInput.value = totalLitros.toFixed(2);
  
              let precioPresentacion = precio * presentacionCantidad;
              precioPresentacionInput.value = precioPresentacion.toFixed(2);
  
              let importe = cantidad * precioPresentacion;
              importeInput.value = importe.toFixed(2);
              updateTotals();
          });
  
          // Evento para actualizar el precio unitario cuando se selecciona un producto
          productoSelect.addEventListener('change', function () {
              let selectedOption = this.options[this.selectedIndex];
              let precio = selectedOption.getAttribute('data-precio') || 0;
              precioInput.value = precio;
              presentacionSelect.dispatchEvent(new Event('change'));
              updateTotals();
          });
  
          // Evento para actualizar los totales cuando cambia la cantidad
          cantidadInput.addEventListener('input', function () {
              presentacionSelect.dispatchEvent(new Event('change'));
              updateTotals();
          });
  
          // Evento para eliminar la fila y verificar si es la última
          deleteButton.addEventListener('click', function () {
              let rows = document.querySelectorAll('.detalle-row');
              if (rows.length > 1) { // Solo eliminar si hay más de una fila
                  row.remove();
                  updateTotals();
              } else {
                  alert('No puedes eliminar todos los productos. Debe haber al menos un producto en el pedido.');
              }
          });
      }
  
      document.querySelectorAll('.detalle-row').forEach(function (row) {
          attachEventListeners(row);
      });
  
      document.getElementById('add-row').addEventListener('click', function () {
          let newRow = document.querySelector('.detalle-row').cloneNode(true);
  
          newRow.querySelectorAll('input, select').forEach(function (input) {
              input.name = input.name.replace(/-\d+-/, `-${formIdx}-`);
              input.id = input.id.replace(/_\d+_/, `_${formIdx}_`);
              if (input.type !== 'hidden') input.value = '';
              if (input.tagName.toLowerCase() === 'select') input.selectedIndex = 0;
          });
  
          document.querySelector('#detalle-productos-table tbody').appendChild(newRow);
          formIdx++;
          totalFormsInput.value = formIdx;
          attachEventListeners(newRow);
          updateTotals();
      });
  
      function updateTotals() {
          let subtotal = 0;
          document.querySelectorAll('.detalle-row').forEach(function (row) {
              let importe = parseFloat(row.querySelector('.importe')?.value) || 0;
              subtotal += importe;
          });
          let iva = subtotal * 0.16;
          let total = subtotal + iva;
          document.getElementById('subtotal').value = subtotal.toFixed(2);
          document.getElementById('iva').value = iva.toFixed(2);
          document.getElementById('total').value = total.toFixed(2);
      }
  
      updateTotals();



});

  </script>
{% endblock %}
