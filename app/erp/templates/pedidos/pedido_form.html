{% extends "base_generic.html" %}

{% block content %}
  <h2>Crear Pedido</h2>
  <form method="post" id="pedido-form">
    {% csrf_token %}
    {{ form.as_p }}
    <h3>Detalle de Productos</h3>
    {{ detalle_formset.management_form }}
    <table class="table" id="detalle-productos-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Atenciones</th>
          <th>Precio Unitario</th>
          <th>Importe</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody>
        {% for form in detalle_formset %}
          <tr class="detalle-row">
            <td>
              <select name="{{ form.prefix }}-producto" class="form-control producto-select">
                <option value="">Seleccione un producto</option>
                {% for producto in productos %}
                  <option value="{{ producto.id }}" data-precio="{{ producto.precio_unitario }}"
                    {% if form.instance.producto and form.instance.producto.id == producto.id %}selected{% endif %}>
                    {{ producto.nombre }}
                  </option>
                {% endfor %}
              </select>
            </td>
            <td>
              <input type="number" name="{{ form.prefix }}-cantidad" class="form-control cantidad" min="1" value="{{ form.cantidad.value }}">
            </td>
            <td>
              <input type="text" name="{{ form.prefix }}-atenciones" class="form-control atenciones" value="{{ form.atenciones.value }}" >
            </td>
            <td>
              <input type="text" name="{{ form.prefix }}-precio_unitario" class="form-control precio-unitario" value="{{ form.precio_unitario.value }}" readonly>
            </td>
            <td>
              <input type="text" name="{{ form.prefix }}-importe" class="form-control importe" value="{{ form.importe.value }}" readonly>
            </td>
            <td>
              <button type="button" class="btn btn-danger remove-row">Eliminar</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <button type="button" id="add-row" class="btn btn-primary">A침adir Producto</button>
    <hr>
    <h3>Resumen del Pedido</h3>
    <div class="form-group">
      <label>Subtotal:</label>
      <input type="text" id="subtotal" class="form-control" readonly>
    </div>
    <div class="form-group">
      <label>IVA (16%):</label>
      <input type="text" id="iva" class="form-control" readonly>
    </div>
    <div class="form-group">
      <label>Total:</label>
      <input type="text" id="total" class="form-control" readonly>
    </div>
    <button type="submit" class="btn btn-success">Guardar Pedido</button>
    <a href="{% url 'pedido-list' %}" class="btn btn-secondary">Cancelar</a>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Funci칩n para actualizar los totales
      function updateTotals() {
        let subtotal = 0;
        document.querySelectorAll('.detalle-row').forEach(function(row) {
          let cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
          let precio = parseFloat(row.querySelector('.precio-unitario').value) || 0;
          let importe = cantidad * precio;
          row.querySelector('.importe').value = importe.toFixed(2);
          subtotal += importe;
        });
        let iva = subtotal * 0.16;
        let total = subtotal + iva;
        document.getElementById('subtotal').value = subtotal.toFixed(2);
        document.getElementById('iva').value = iva.toFixed(2);
        document.getElementById('total').value = total.toFixed(2);
      }

      // Evento para actualizar el precio y calcular el importe
      document.querySelectorAll('.producto-select').forEach(function(select) {
        select.addEventListener('change', function() {
          let precio = select.options[select.selectedIndex].getAttribute('data-precio');
          let row = select.closest('.detalle-row');
          row.querySelector('.precio-unitario').value = precio;
          updateTotals();
        });
      });

      // Evento para calcular el importe al cambiar la cantidad
      document.querySelectorAll('.cantidad').forEach(function(input) {
        input.addEventListener('input', updateTotals);
      });

      // Evento para eliminar una fila
      document.querySelectorAll('.remove-row').forEach(function(button) {
        button.addEventListener('click', function() {
          this.closest('.detalle-row').remove();
          updateTotals();
        });
      });

      // A침adir nueva fila de productos
      document.getElementById('add-row').addEventListener('click', function() {
        let newRow = document.querySelector('.detalle-row').cloneNode(true);
        newRow.querySelectorAll('input').forEach(function(input) {
          input.value = '';
        });
        newRow.querySelector('.producto-select').selectedIndex = 0;
        newRow.querySelector('.importe').value = '';
        document.getElementById('detalle-productos-table').querySelector('tbody').appendChild(newRow);
        newRow.querySelector('.remove-row').addEventListener('click', function() {
          newRow.remove();
          updateTotals();
        });
        newRow.querySelector('.producto-select').addEventListener('change', function() {
          let precio = newRow.querySelector('.producto-select').options[newRow.querySelector('.producto-select').selectedIndex].getAttribute('data-precio');
          newRow.querySelector('.precio-unitario').value = precio;
          updateTotals();
        });
        newRow.querySelector('.cantidad').addEventListener('input', updateTotals);
        updateTotals();
      });

      // Inicializar c치lculo de totales
      updateTotals();
    });
  </script>
{% endblock %}