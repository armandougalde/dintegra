{% extends "body.html" %}
{% load static %}

{% block content %}
<div class="container">
    <h1 class="mt-4">Cargar Datos de Localidades</h1>
    <form id="uploadForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <label for="archivo_csv">Selecciona un archivo CSV:</label>
            <input type="file" name="archivo_csv" id="archivo_csv" accept=".csv" class="form-control" required>
        </div>
        <button type="button" id="cargarBtn" class="btn btn-primary" onclick="iniciarCarga()">Cargar Datos</button>
        <button type="button" id="cancelarBtn" class="btn btn-danger ml-2" style="display: none;" onclick="cancelarCarga()">Cancelar Carga</button>
    </form>

    <!-- Barra de progreso -->
    <div id="spinner" class="progress mt-3" style="display: none;">
        <div id="progressBar" class="progress-bar progress-bar-striped bg-warning progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            0%
        </div>
    </div>

    <!-- Mensajes de éxito o error -->
    <div id="mensajeExito" class="alert alert-success mt-3" style="display: none;">
        Datos cargados exitosamente.
    </div>
    <div id="mensajeError" class="alert alert-danger mt-3" style="display: none;">
        Error al cargar el archivo.
    </div>
</div>

<!-- Script para controlar la carga y progreso -->
<script>
    let abortController;  // Variable global para controlar la cancelación de la carga

    // Función para iniciar la carga del archivo con fetch y mostrar progreso
    async function iniciarCarga() {
        const archivo = document.getElementById('archivo_csv').files[0];
        if (!archivo) {
            alert('Por favor, selecciona un archivo CSV antes de cargar.');
            return;
        }

        // Mostrar la barra de progreso y botón de cancelar
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('cancelarBtn').style.display = 'inline';
        document.getElementById('cargarBtn').disabled = true;

        // Crear un FormData con el archivo y CSRF token
        const formData = new FormData();
        formData.append('archivo_csv', archivo);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        // Configurar el AbortController para controlar la cancelación
        abortController = new AbortController();

        try {
            // Realizar la solicitud con `fetch` y leer la respuesta como un stream
            const response = await fetch("{% url 'cargar_datos' %}", {
                method: 'POST',
                body: formData,
                signal: abortController.signal,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'  // Para indicar que es una solicitud AJAX
                }
            });

            // Verificar que la respuesta sea exitosa
            if (response.ok) {
                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                let bytesReceived = 0;

                // Leer los datos de manera incremental para actualizar la barra de progreso
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    bytesReceived += value.length;
                    const porcentaje = Math.round((bytesReceived / contentLength) * 100);

                    // Actualizar la barra de progreso
                    document.getElementById('progressBar').style.width = porcentaje + '%';
                    document.getElementById('progressBar').innerHTML = porcentaje + '%';
                    document.getElementById('progressBar').setAttribute('aria-valuenow', porcentaje);
                }

                document.getElementById('mensajeExito').style.display = 'block';
                document.getElementById('progressBar').innerHTML = '100% - Carga Completa';
            } else {
                throw new Error('Error en la carga del archivo');
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                document.getElementById('mensajeError').innerHTML = 'Carga cancelada por el usuario.';
            } else {
                document.getElementById('mensajeError').innerHTML = 'Error: ' + error.message;
            }
            document.getElementById('mensajeError').style.display = 'block';
        } finally {
            document.getElementById('cancelarBtn').style.display = 'none';
            document.getElementById('cargarBtn').disabled = false;
        }
    }

    // Función para cancelar la carga del archivo
    function cancelarCarga() {
        if (abortController) {
            abortController.abort();  // Cancelar la carga
        }
    }
</script>

{% endblock %}
